<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>毕业论文管理系统</title>
    <link rel="icon" href="assets/images/favicon.ico"/>
    <link rel="stylesheet" href="assets/libs/layui/css/layui.css">
    <link rel="stylesheet" href="assets/common.css">
</head>

<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
    <div class="layui-header">
        <a href="index.html">
            <div class="layui-logo">毕业论文管理系统</div>
        </a>
        <ul class="layui-nav layui-layout-right">
            <li class="layui-nav-item" lay-unselect>
                <a style="margin-right: 40px"><img src="assets/images/head.png" class="layui-nav-img"><span id="uName">用户名</span></a>
                <dl class="layui-nav-child">
                    <dd><a id="btnData" href="javascript:;">修改个人资料</a></dd>
                    <dd><a id="btnUP" href="javascript:;">修改密码</a></dd>
                    <dd><a id="btnExit" href="javascript:;">退出登录</a></dd>
                </dl>
            </li>
        </ul>
    </div>

    <div class="layui-side">
        <div class="layui-side-scroll">
            <ul class="layui-nav layui-nav-tree" style="margin-top: 10px;">
                <li class="layui-nav-item">
                    <a><i class="layui-icon layui-icon-notice"></i>&emsp;公告信息</a>
                    <dl class="layui-nav-child">
                        <dd class="layui-this"><a lay-href="pages/noticeList.html">公告列表</a></dd>
                        <dd id="notice"><a lay-href="pages/notice.html">公告管理</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item">
                    <a><i class="layui-icon layui-icon-username"></i>&emsp;账号信息</a>
                    <dl class="layui-nav-child">
                        <dd id="admin"><a lay-href="pages/admin.html">管理员</a></dd>
                        <dd><a lay-href="pages/teacher.html">指导老师列表</a></dd>
                        <dd><a lay-href="pages/student.html">学生列表</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item">
                    <a><i class="layui-icon layui-icon-read"></i>&emsp;论文信息</a>
                    <dl class="layui-nav-child">
                        <dd><a lay-href="pages/thesis.html">论文列表</a></dd>
                        <dd id="myThesis"><a lay-href="pages/myThesis.html">我的论文</a></dd>
                    </dl>
                </li>
                <li class="layui-nav-item">
                    <a><i class="layui-icon layui-icon-form"></i>&emsp;选题信息</a>
                    <dl class="layui-nav-child">
                        <dd><a lay-href="pages/selectedThesis.html">选题列表</a></dd>
                        <dd id="waitConfirm"><a lay-href="pages/waitConfirm.html">等待确认列表</a></dd>
                        <dd id="confirmedThesis"><a lay-href="pages/confirmedThesis.html">已确认列表</a></dd>
                        <dd id="openTime"><a lay-href="pages/openTime.html">选题时间管理</a></dd>
                    </dl>
                </li>
            </ul>
        </div>
    </div>

    <div class="layui-body">
        <iframe name="body" class="admin-iframe" src="pages/noticeList.html" frameborder="0"></iframe>
    </div>
</div>
<!-- 修改密码弹窗 -->
<script type="text/html" id="upModel">
    <form class="layui-form model-form" id="formPsw">
        <div class="layui-form-item">
            <label class="layui-form-label">新密码:</label>
            <div class="layui-input-block">
                <input type="password" name="pwd" placeholder="请输入新密码" class="layui-input"
                       lay-verType="tips" lay-verify="required|pwd" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">确认密码:</label>
            <div class="layui-input-block">
                <input type="password" name="rePsw" placeholder="请再次输入新密码" class="layui-input"
                       lay-verType="tips" lay-verify="required|repsw" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block text-right">
                <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
                <button class="layui-btn" lay-filter="submitPsw" lay-submit>保存</button>
            </div>
        </div>
    </form>
</script>

<!--管理员修改资料弹窗-->
<script type="text/html" id="adminForm">
    <form lay-filter="adminForm" class="layui-form model-form">
        <div class="layui-form-item">
            <label class="layui-form-label">账号</label>
            <div class="layui-input-block">
                <input name="adminId" placeholder="请输入账号" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-block">
                <input name="adminName" placeholder="请输入姓名" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">性别</label>
            <div class="layui-input-block">
                <input type="radio" name="adminSex" value="男" title="男" checked/>
                <input type="radio" name="adminSex" value="女" title="女"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">手机号</label>
            <div class="layui-input-block">
                <input name="phone" placeholder="请输入手机号" type="text" class="layui-input"
                       lay-verify="required|phone" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">邮箱</label>
            <div class="layui-input-block">
                <input name="email" placeholder="请输入邮箱" type="text" class="layui-input"
                       lay-verify="required|email" required/>
            </div>
        </div>
        <div class="layui-form-item text-right">
            <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
            <button class="layui-btn" lay-filter="adminFormSubmit" lay-submit>保存</button>
        </div>
    </form>
</script>

<!--教师修改资料弹窗-->
<script type="text/html" id="techForm">
    <form lay-filter="techForm" class="layui-form model-form">
        <div class="layui-form-item">
            <label class="layui-form-label">账号</label>
            <div class="layui-input-block">
                <input name="techId" placeholder="请输入账号" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-block">
                <input name="techName" placeholder="请输入姓名" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">性别</label>
            <div class="layui-input-block">
                <input type="radio" name="techSex" value="男" title="男" checked/>
                <input type="radio" name="techSex" value="女" title="女"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">学历</label>
            <div class="layui-input-block">
                <input name="education" placeholder="请输入学历" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">学位</label>
            <div class="layui-input-block">
                <input name="degree" placeholder="请输入学位" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">研究方向</label>
            <div class="layui-input-block">
                <input name="researchDirection" placeholder="请输入研究方向" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">职称</label>
            <div class="layui-input-block">
                <input name="jobTitle" placeholder="请输入职称" type="text" class="layui-input" maxlength="20">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">职务</label>
            <div class="layui-input-block">
                <input name="job" placeholder="请输入职务" type="text" class="layui-input" maxlength="20"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">指导人数</label>
            <div class="layui-input-block">
                <input name="instructNums" placeholder="请输入指导人数" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">指导专业</label>
            <div class="layui-input-block">
                <input name="instructMajor" placeholder="请输入指导专业" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">邮箱</label>
            <div class="layui-input-block">
                <input name="email" placeholder="请输入邮箱" type="text" class="layui-input"
                       lay-verify="required|email" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">手机号</label>
            <div class="layui-input-block">
                <input name="phone" placeholder="请输入手机号" type="text" class="layui-input"
                       lay-verify="required|phone" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">QQ</label>
            <div class="layui-input-block">
                <input name="qq" placeholder="请输入QQ" type="text" class="layui-input"
                       lay-verify="required|number" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">微信</label>
            <div class="layui-input-block">
                <input name="weChat" placeholder="请输入微信" type="text" class="layui-input"
                       lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item text-right">
            <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
            <button class="layui-btn" lay-filter="techFormSubmit" lay-submit>保存</button>
        </div>
    </form>
</script>

<!--学生修改资料弹窗-->
<script type="text/html" id="stuForm">
    <form lay-filter="stuForm" class="layui-form model-form">
        <div class="layui-form-item">
            <label class="layui-form-label">账号</label>
            <div class="layui-input-block">
                <input name="stuNo" placeholder="请输入学号" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">姓名</label>
            <div class="layui-input-block">
                <input name="stuName" placeholder="请输入姓名" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">性别</label>
            <div class="layui-input-block">
                <input type="radio" name="stuSex" value="男" title="男" checked/>
                <input type="radio" name="stuSex" value="女" title="女"/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">身份证</label>
            <div class="layui-input-block">
                <input name="idCard" placeholder="请输入身份证" type="text" class="layui-input"
                       maxlength="20" lay-verify="required|identity" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">籍贯</label>
            <div class="layui-input-block">
                <input name="birthplace" placeholder="请输入籍贯" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">院系</label>
            <div class="layui-input-block">
                <input name="department" placeholder="请输入院系" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">专业</label>
            <div class="layui-input-block">
                <input name="major" placeholder="请输入专业" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">班级</label>
            <div class="layui-input-block">
                <input name="class" placeholder="请输入班级" type="text" class="layui-input"
                       maxlength="20" lay-verify="required" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">手机号</label>
            <div class="layui-input-block">
                <input name="phone" placeholder="请输入手机号" type="text" class="layui-input"
                       lay-verify="required|phone" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">QQ</label>
            <div class="layui-input-block">
                <input name="qq" placeholder="请输入QQ" type="text" class="layui-input"
                       lay-verify="required|number" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">邮箱</label>
            <div class="layui-input-block">
                <input name="email" placeholder="请输入邮箱" type="text" class="layui-input"
                       lay-verify="required|email" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">学制</label>
            <div class="layui-input-block">
                <input name="schoolSystem" placeholder="请输入指导学制" type="text" class="layui-input"
                       maxlength="20" lay-verify="required|number" required/>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">入学日期</label>
            <div class="layui-input-block">
                <input name="entryDate" type="text" class="layui-input" id="entryDate"
                       placeholder="请选择时间">
            </div>
        </div>
        <div class="layui-form-item text-right">
            <button class="layui-btn layui-btn-primary" type="button" ew-event="closeDialog">取消</button>
            <button class="layui-btn" lay-filter="stuFormSubmit" lay-submit>保存</button>
        </div>
    </form>
</script>


<script type="text/javascript" src="assets/libs/layui/layui.js"></script>
<script type="text/javascript" src="assets/common.js"></script>
<script>
    layui.use(['jquery', 'layer', 'element', 'form', 'admin', 'laydate'], function () {
        var $ = layui.jquery;
        var layer = layui.layer;
        var form = layui.form;
        var admin = layui.admin;
        var laydate = layui.laydate;
        var role;//角色
        var adminId;//管理员id
        var techId;//教师id
        var stuNo;//学生id

        if (!admin.getToken()) {
            location.replace('login.html');
        }

        //获取用户基本信息
        layer.load(2);
        admin.req('userInfo', {}, function (res) {
            layer.closeAll('loading');
            if (0 == res.status.code) {
                role = res.data.role;
                admin.putRole(res.data.role);
                if (res.data.role == "admin") {
                    adminId = res.data.adminInfo.adminId;
                    $('#uName').text(res.data.adminInfo.adminName);
                    $('#myThesis').hide();
                    $('#waitConfirm').hide();
                    $('#confirmedThesis').hide();
                } else if (res.data.role == "teacher") {
                    techId = res.data.techInfo.techId;
                    $('#uName').text(res.data.techInfo.techName);
                    $('#notice').hide();
                    $('#admin').hide();
                    $('#myThesis').hide();
                    $('#openTime').hide();
                } else {
                    stuNo = res.data.stuInfo.stuNo;
                    $('#uName').text(res.data.stuInfo.stuName);
                    $('#notice').hide();
                    $('#admin').hide();
                    $('#waitConfirm').hide();
                    $('#confirmedThesis').hide();
                    $('#openTime').hide();
                }
            } else {
                layer.msg(res.status.message, {icon: 2});
                location.replace('login.html');
            }
        }, 'GET');

        // 退出登录
        $('#btnExit').click(function () {
            layer.confirm('确定退出登录吗？', function (i) {
                layer.close(i);
                //安全退出
                admin.req('account/logout', {}, function (res) {
                    layer.closeAll('loading');
                    if (0 == res.status.code) {
                        location.replace('login.html');
                    }
                }, 'DELETE');
                //删除本地缓存token,role
                admin.removeToken();
                admin.removeRole();
            });
        });

        // 修改密码弹框
        $('#btnUP').click(function () {
            layer.open({
                type: 1,
                title: '修改密码',
                area: '360px',
                offset: '65px',
                content: $('#upModel').html()
            });
        });

        // 监听修改密码表单提交
        form.on('submit(submitPsw)', function (d) {
            layer.load(2);
            if (role == "admin") {
                d.field.adminId = adminId;
            } else if (role == "teacher'") {
                d.field.techId = techId;
            } else {
                d.field.stuNo = stuNo;
            }
            admin.req('account?role=' + role, d.field, function (res) {
                if (0 == res.status.code) {
                    layer.closeAll('loading');
                    layer.closeAll('page');
                    layer.msg('修改成功', {icon: 1, time: 1500}, function () {
                        location.replace('login.html');
                    });
                } else {
                    layer.closeAll('loading');
                    layer.msg(res.status.message, {icon: 2});
                }
            }, 'PUT');
            return false;
        });

        // 修改资料
        $('#btnData').click(function () {
            //获取用户基本信息
            admin.areq('userInfo', {}, function (res) {
                adminData = res.data.adminInfo;
                techData = res.data.techInfo;
                stuData = res.data.stuInfo;
            }, 'GET');
            if (role == "admin") {
                layer.closeAll('loading');
                layer.open({
                    type: 1,
                    title: '修改资料',
                    area: '360px',
                    offset: '65px',
                    content: $('#adminForm').html(),
                    success: function (layero, index) {
                        $(layero).children('.layui-layer-content').css('overflow', 'visible');
                        form.render('radio');
                        // 回显admin数据
                        form.val('adminForm', adminData);
                        // 表单提交事件
                        form.on('submit(adminFormSubmit)', function (d) {
                            layer.load(2);
                            admin.req('account?role=admin', d.field, function (res) {
                                layer.closeAll('loading');
                                if (res.status.code == 0) {
                                    layer.msg('修改成功', {icon: 1});
                                    layer.closeAll('page');
                                } else {
                                    layer.msg(res.status.message, {icon: 2});
                                }
                            }, 'PUT');
                            // return false;
                        });
                    }
                });
            } else if (role == "teacher") {
                layer.closeAll('loading');
                layer.open({
                    type: 1,
                    title: '修改资料',
                    area: '360px',
                    offset: '65px',
                    content: $('#techForm').html(),
                    success: function (layero, index) {
                        $(layero).children('.layui-layer-content').css('overflow', 'visible');
                        form.render('radio');
                        // 回显tech数据
                        form.val('techForm', techData);
                        // 表单提交事件
                        form.on('submit(techFormSubmit)', function (d) {
                            layer.load(2);
                            admin.req('account?role=teacher', d.field, function (res) {
                                layer.closeAll('loading');
                                if (res.status.code == 0) {
                                    layer.msg('修改成功', {icon: 1});
                                    layer.closeAll('page');
                                } else {
                                    layer.msg(res.status.message, {icon: 2});
                                }
                            }, 'PUT');
                            return false;
                        });
                    }
                });
            } else {
                layer.closeAll('loading');
                layer.open({
                    type: 1,
                    title: '修改资料',
                    area: '360px',
                    offset: '65px',
                    content: $('#stuForm').html(),
                    success: function (layero, index) {
                        $(layero).children('.layui-layer-content').css('overflow', 'visible');
                        form.render('radio');
                        // 回显stu数据
                        form.val('stuForm', stuData);
                        //日期选择器
                        laydate.render({
                            elem: '#entryDate',
                            type: 'datetime'
                        });
                        // 表单提交事件
                        form.on('submit(stuFormSubmit)', function (d) {
                            layer.load(2);
                            admin.req('account?role=student', d.field, function (res) {
                                layer.closeAll('loading');
                                if (res.status.code == 0) {
                                    layer.msg('修改成功', {icon: 1});
                                    layer.closeAll('page');
                                } else {
                                    layer.msg(res.status.message, {icon: 2});
                                }
                            }, 'PUT');
                            return false;
                        });
                    }
                });
            }

        });

        // 验证密码
        form.verify({
            pwd: [/^[\S]{5,12}$/, '密码必须5到12位，且不能出现空格'],
            repsw: function (t) {
                if (t !== $('#formPsw input[name=pwd]').val()) {
                    return '两次密码输入不一致';
                }
            }
        });

    });
</script>
</body>
</html>